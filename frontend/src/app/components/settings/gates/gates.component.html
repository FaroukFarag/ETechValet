<div class="gates-page">
  <div class="page-header">
    <div class="header-text">
      <h1>Gates</h1>
    </div>
    <div class="header-actions">
      <button class="secondary-btn" type="button" (click)="exportGates()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        <span>Export</span>
      </button>
      <button class="primary-btn" type="button" (click)="addGate()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        <span>Add Gates</span>
      </button>
    </div>
  </div>

  <ng-container *ngIf="!isLoading && !loadError && gates.length > 0; else stateTemplate">
    <div class="table-card">
      <table class="gates-table">
        <thead>
          <tr>
            <th>Gate Name <span class="sort-icon"></span></th>
            <th>Site Name <span class="sort-icon"></span></th>
            <th>Status <span class="sort-icon"></span></th>
            <th class="actions-col"></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let gate of gates; index as i">
            <td>{{ gate.gateName }}</td>
            <td>{{ gate.siteName }}</td>
            <td>
              <span class="status-badge" [ngClass]="getStatusClass(gate.status)">{{ gate.status }}</span>
            </td>
            <td class="actions-cell">
              <div class="actions-wrapper">
                <button type="button" class="icon-btn" (click)="toggleMenu(i, $event)" aria-label="Gate actions">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="5" r="1"></circle>
                    <circle cx="12" cy="12" r="1"></circle>
                    <circle cx="12" cy="19" r="1"></circle>
                  </svg>
                </button>
                <div class="actions-menu" *ngIf="openMenuIndex === i">
                  <button type="button" class="menu-item" (click)="editGate(gate, $event)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M17 3a2.828 2.828 0 0 1 4 4L7 21H3v-4L17 3z"></path>
                    </svg>
                    <span>Update</span>
                  </button>
                  <button type="button" class="menu-item danger" (click)="deleteGate(gate, $event)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                      <path d="M10 11v6"></path>
                      <path d="M14 11v6"></path>
                      <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path>
                    </svg>
                    <span>Delete</span>
                  </button>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="pagination">
      <button type="button" class="page-btn">&larr; Previous</button>
      <div class="page-numbers">
        <button type="button" class="page-number active">1</button>
        <button type="button" class="page-number">2</button>
        <button type="button" class="page-number">3</button>
        <span class="ellipsis">...</span>
        <button type="button" class="page-number">9</button>
        <button type="button" class="page-number">10</button>
      </div>
      <button type="button" class="page-btn">Next &rarr;</button>
    </div>
  </ng-container>

  <div class="confirm-overlay" *ngIf="showDeleteConfirm" (click)="cancelDelete()"></div>
  <div class="confirm-dialog" *ngIf="showDeleteConfirm" (click)="$event.stopPropagation()">
    <h3>Delete Gate</h3>
    <p>Are you sure you want to delete this gate? This action cannot be undone.</p>
    <div class="confirm-actions">
      <button type="button" class="secondary-btn" (click)="cancelDelete()">Cancel</button>
      <button type="button" class="danger-btn" (click)="confirmDelete()">Delete</button>
    </div>
  </div>

  <ng-template #stateTemplate>
    <div class="table-card status-card">
      <div *ngIf="isLoading" class="status-content">
        <div class="spinner"></div>
        <p>Loading gates...</p>
      </div>
      <div *ngIf="!isLoading && loadError" class="status-content">
        <p>{{ loadError }}</p>
        <button type="button" class="secondary-btn" (click)="fetchGates()">Retry</button>
      </div>
      <div *ngIf="!isLoading && !loadError && gates.length === 0" class="status-content">
        <p>No gates available yet.</p>
        <button type="button" class="primary-btn" (click)="addGate()">Add Gates</button>
      </div>
    </div>
  </ng-template>

  <div class="drawer-overlay" *ngIf="showDrawer" (click)="closeDrawer()"></div>
  <div class="drawer" [class.open]="showDrawer" (click)="closeDrawer()">
    <form class="drawer-content" [formGroup]="addGateForm" (ngSubmit)="submitGate()" (click)="$event.stopPropagation()">
      <div class="drawer-header">
        <h2>{{ isEditMode ? 'Update Gate' : 'Add New Gate' }}</h2>
        <button type="button" class="close-btn" (click)="closeDrawer()" aria-label="Close">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <div class="drawer-body">
        <div class="form-field" [class.invalid]="addGateForm.get('name')?.invalid && addGateForm.get('name')?.touched">
          <label>Gate name*</label>
          <select formControlName="name">
            <option value="" disabled>Please Select Type</option>
            <option *ngFor="let gate of gateOptions" [value]="gate">{{ gate }}</option>
          </select>
        </div>

        <div class="form-field" [class.invalid]="addGateForm.get('siteId')?.invalid && addGateForm.get('siteId')?.touched">
          <label>Site Name*</label>
          <select formControlName="siteId">
            <option [ngValue]="null" disabled>Please Select Type</option>
            <option *ngFor="let site of siteOptions" [ngValue]="site.id">{{ site.name }}</option>
          </select>
        </div>

        <div class="form-field" [class.invalid]="addGateForm.get('status')?.invalid && addGateForm.get('status')?.touched">
          <label>Status*</label>
          <select formControlName="status">
            <option [ngValue]="null" disabled>Please Select Type</option>
            <option *ngFor="let option of statusOptions" [ngValue]="option.value">{{ option.label }}</option>
          </select>
        </div>
      </div>

      <div class="drawer-footer">
        <button type="button" class="secondary-btn" (click)="closeDrawer()" [disabled]="isSaving">Cancel</button>
        <button type="submit" class="primary-btn" [disabled]="isSaving">
          <span *ngIf="!isSaving">{{ isEditMode ? 'Update' : 'Save' }}</span>
          <span *ngIf="isSaving">Saving...</span>
        </button>
      </div>
    </form>
  </div>
</div>
