<div class="companies-page">
  <div class="page-header">
    <div class="header-text">
      <h1>Companies</h1>
    </div>
    <div class="header-actions">
      <button class="secondary-btn" type="button" (click)="exportCompanies()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        <span>Export</span>
      </button>
      <button class="primary-btn" type="button" (click)="openAddCompany()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        <span>Add New Company</span>
      </button>
    </div>
  </div>

  <div class="table-card" *ngIf="!isLoading && companies.length > 0; else loadingOrEmpty">
    <table class="companies-table">
      <thead>
        <tr>
          <th>
            Company Name
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M6 9l6 6 6-6"></path>
            </svg>
          </th>
          <th>
            Short Name
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M6 9l6 6 6-6"></path>
            </svg>
          </th>
          <th>
            Contact Person
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M6 9l6 6 6-6"></path>
            </svg>
          </th>
          <th>
            Phone numbers
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M6 9l6 6 6-6"></path>
            </svg>
          </th>
          <th>
            Address
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M6 9l6 6 6-6"></path>
            </svg>
          </th>
          <th>
            Commercial Registrations
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M6 9l6 6 6-6"></path>
            </svg>
          </th>
          <th class="actions-col"></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let company of companies; index as i">
          <td>{{ company.name }}</td>
          <td>{{ company.shortName }}</td>
          <td>{{ company.contactPerson }}</td>
          <td>{{ company.phoneNumber }}</td>
          <td class="address">{{ company.address }}</td>
          <td>{{ company.commercialRegistration }}</td>
          <td class="actions-cell">
            <div class="actions-wrapper">
              <button class="icon-btn" type="button" aria-label="Company actions" (click)="toggleMenu(i, $event)">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="5" r="1"></circle>
                  <circle cx="12" cy="12" r="1"></circle>
                  <circle cx="12" cy="19" r="1"></circle>
                </svg>
              </button>
              <div class="actions-menu" *ngIf="openMenuIndex === i">
                <button type="button" class="menu-item" (click)="editCompany(company, $event)">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M17 3a2.828 2.828 0 0 1 4 4L7 21H3v-4L17 3z"></path>
                  </svg>
                  <span>Update</span>
                </button>
                <button type="button" class="menu-item danger" (click)="deleteCompany(company, $event)">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                    <path d="M10 11v6"></path>
                    <path d="M14 11v6"></path>
                    <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path>
                  </svg>
                  <span>Delete</span>
                </button>
              </div>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <ng-template #loadingOrEmpty>
    <div class="table-card status-card">
      <div *ngIf="isLoading" class="status-content">
        <div class="spinner"></div>
        <p>Loading companies...</p>
      </div>
      <div *ngIf="!isLoading && loadError" class="status-content">
        <p>{{ loadError }}</p>
        <button type="button" class="secondary-btn" (click)="fetchCompanies()">Retry</button>
      </div>
      <div *ngIf="!isLoading && !loadError && companies.length === 0" class="status-content">
        <p>No companies available yet.</p>
        <button type="button" class="primary-btn" (click)="openAddCompany()">Add New Company</button>
      </div>
    </div>
  </ng-template>

  <div class="confirm-overlay" *ngIf="showDeleteConfirm" (click)="cancelDelete()"></div>
  <div class="confirm-dialog" *ngIf="showDeleteConfirm" (click)="$event.stopPropagation()">
    <h3>Delete Company</h3>
    <p>Are you sure you want to delete this company? This action cannot be undone.</p>
    <div class="confirm-actions">
      <button type="button" class="secondary-btn" (click)="cancelDelete()">Cancel</button>
      <button type="button" class="danger-btn" (click)="confirmDelete()">Delete</button>
    </div>
  </div>

  <div class="pagination">
    <button type="button" class="page-btn" [disabled]="currentPage === 1" (click)="previousPage()">
      &larr; Previous
    </button>
    <div class="page-numbers">
      <button
        *ngFor="let page of getPaginationPages()"
        type="button"
        class="page-number"
        [class.active]="page === currentPage"
        [class.ellipsis]="page === '...'"
        [disabled]="page === '...'"
        (click)="handlePageClick(page)">
        {{ page }}
      </button>
    </div>
    <button type="button" class="page-btn" [disabled]="currentPage === totalPages" (click)="nextPage()">
      Next &rarr;
    </button>
  </div>

  <div class="drawer-overlay" *ngIf="showAddCompanyDrawer" (click)="closeAddCompany()"></div>
  <div class="drawer" [class.open]="showAddCompanyDrawer" (click)="closeAddCompany()">
    <form [formGroup]="addCompanyForm" (ngSubmit)="submitAddCompany()" class="drawer-content" (click)="$event.stopPropagation()">
      <div class="drawer-header">
        <h2>{{ isEditMode ? 'Update Company' : 'Add New Company' }}</h2>
        <button type="button" class="close-btn" (click)="closeAddCompany()" aria-label="Close">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <div class="drawer-body">
        <div class="form-field" [class.invalid]="addCompanyForm.get('name')?.invalid && addCompanyForm.get('name')?.touched">
          <label>Company name*</label>
          <input type="text" formControlName="name" placeholder="Enter company name" />
        </div>

        <div class="form-field" [class.invalid]="addCompanyForm.get('shortName')?.invalid && addCompanyForm.get('shortName')?.touched">
          <label>Short Company Name*</label>
          <input type="text" formControlName="shortName" placeholder="Enter short name" />
        </div>

        <div class="form-field" [class.invalid]="addCompanyForm.get('contactPerson')?.invalid && addCompanyForm.get('contactPerson')?.touched">
          <label>Contact Person*</label>
          <input type="text" formControlName="contactPerson" placeholder="Enter contact person" />
        </div>

        <div class="form-field" [class.invalid]="addCompanyForm.get('phoneNumber')?.invalid && addCompanyForm.get('phoneNumber')?.touched">
          <label>Phone Number*</label>
          <input type="tel" formControlName="phoneNumber" placeholder="Enter phone number" />
        </div>

        <div class="form-field" [class.invalid]="addCompanyForm.get('address')?.invalid && addCompanyForm.get('address')?.touched">
          <label>Address*</label>
          <textarea formControlName="address" rows="2" placeholder="Enter address"></textarea>
        </div>

        <div class="form-field" [class.invalid]="addCompanyForm.get('commercialRegistration')?.invalid && addCompanyForm.get('commercialRegistration')?.touched">
          <label>Commercial Registration*</label>
          <input type="text" formControlName="commercialRegistration" placeholder="Enter commercial registration" />
        </div>
      </div>

      <div class="drawer-footer">
        <button type="button" class="secondary-btn" (click)="closeAddCompany()" [disabled]="isSaving">Cancel</button>
        <button type="submit" class="primary-btn" [disabled]="isSaving">
          <span *ngIf="!isSaving">{{ isEditMode ? 'Update' : 'Save' }}</span>
          <span *ngIf="isSaving">Saving...</span>
        </button>
      </div>
    </form>
  </div>
</div>
